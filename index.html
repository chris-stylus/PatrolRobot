<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patrol Robot Command Center</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet CSS (OpenStreetMap) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <style>
        body { font-family: 'Share Tech Mono', monospace; background-color: #0f172a; color: #00ff41; user-select: none; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); border: 1px solid #00ff41; backdrop-filter: blur(5px); }
        .btn-control { transition: all 0.1s; border: 2px solid #00ff41; cursor: pointer; }
        .btn-control:active, .btn-control.active-key { transform: scale(0.92); background-color: #00ff41; color: black; box-shadow: 0 0 15px #00ff41; }
        .alert-active { animation: blink 1s infinite; background-color: rgba(220, 38, 38, 0.3); border-color: #ef4444; color: #ef4444; }
        @keyframes blink { 50% { opacity: 0.5; } }
        /* Scrollbar for logs */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #00ff41; border-radius: 4px; }
        /* Fix Leaflet z-index issues with Tailwind */
        .leaflet-pane { z-index: 0 !important; }
        .leaflet-top, .leaflet-bottom { z-index: 10 !important; }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col">

    <!-- Header -->
    <header class="mb-4 flex justify-between items-center border-b border-green-500 pb-2 shrink-0">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold tracking-wider"><i class="fas fa-robot"></i> S3-PATROL</h1>
            <div class="text-xs text-green-600">TACTICAL SURVEILLANCE UNIT</div>
        </div>
        <div id="connectionStatus" class="text-xs md:text-sm bg-red-900 px-3 py-1 rounded border border-red-500 animate-pulse">OFFLINE</div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow">
        
        <!-- COLUMN 1: MAP & VIDEO -->
        <div class="glass-panel p-2 rounded-lg col-span-1 lg:col-span-2 flex flex-col relative min-h-[300px]">
            <div class="flex justify-between items-center mb-2 px-2">
                <h2 class="bg-black px-2 text-sm border border-green-500">LIVE GPS FEED</h2>
                <div class="text-xs text-gray-400"><i class="fas fa-satellite"></i> SATELLITES: 4</div>
            </div>
            <div id="map" class="w-full flex-grow bg-slate-800 rounded opacity-90 border border-green-900/50"></div>
        </div>

        <!-- COLUMN 2: CONTROLS & TELEMETRY -->
        <div class="flex flex-col gap-4">
            
            <!-- Telemetry Strip -->
            <div class="glass-panel p-3 rounded-lg">
                <h2 class="text-lg border-b border-gray-600 pb-1 mb-2 text-center">SENSOR ARRAY</h2>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-slate-900/80 p-2 rounded border border-green-900">
                        <div class="text-[10px] text-gray-400">DISTANCE (CM)</div>
                        <div class="text-2xl font-bold" id="val-dist">---</div>
                    </div>
                    <div class="bg-slate-900/80 p-2 rounded border border-green-900">
                        <div class="text-[10px] text-gray-400">NOISE (RAW)</div>
                        <div class="text-2xl font-bold" id="val-noise">---</div>
                    </div>
                    <div class="bg-slate-900/80 p-2 rounded border border-green-900">
                        <div class="text-[10px] text-gray-400">SPEED (KM/H)</div>
                        <div class="text-2xl font-bold" id="val-speed">0.0</div>
                    </div>
                    <div class="bg-slate-900/80 p-2 rounded border border-green-900">
                        <div class="text-[10px] text-gray-400">SYS VOLTAGE</div>
                        <div class="text-2xl font-bold text-yellow-400">12.4V</div>
                    </div>
                </div>
                <div id="alert-box" class="mt-2 p-1 text-center text-xs bg-slate-800 rounded text-gray-500">
                    SCANNING FOR THREATS...
                </div>
            </div>

            <!-- Command Module -->
            <div class="glass-panel p-4 rounded-lg flex-grow flex flex-col justify-center">
                <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-1">
                    <h2 class="text-lg">COMMAND</h2>
                    <div id="cmd-status" class="text-xs bg-black px-2 py-0.5 rounded text-green-400">READY</div>
                </div>
                
                <!-- Mode Switch -->
                <div class="flex mb-4 bg-slate-900 p-1 rounded border border-green-800">
                    <button onclick="setMode('manual')" id="btn-manual" class="flex-1 py-1 text-sm rounded bg-green-600 text-black font-bold hover:opacity-90">MANUAL</button>
                    <button onclick="setMode('auto')" id="btn-auto" class="flex-1 py-1 text-sm rounded text-gray-400 hover:text-white">AUTONOMOUS</button>
                </div>

                <!-- Speed Slider (UI Only for now) -->
                <div class="mb-4 px-2">
                    <label class="text-[10px] text-gray-400 flex justify-between">
                        <span>THROTTLE LIMIT</span>
                        <span id="speed-val">100%</span>
                    </label>
                    <input type="range" min="0" max="100" value="100" class="w-full accent-green-500 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('speed-val').innerText = this.value + '%'">
                </div>

                <!-- D-PAD -->
                <div id="dpad" class="grid grid-cols-3 gap-2 max-w-[180px] mx-auto mb-4">
                    <div></div>
                    <button id="btn-fwd" 
                        onmousedown="handleInput('fwd', this)" ontouchstart="handleInput('fwd', this, event)"
                        class="btn-control h-14 rounded bg-slate-800 flex items-center justify-center text-xl shadow-lg">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                    <div></div>
                    
                    <button id="btn-left" 
                        onmousedown="handleInput('left', this)" ontouchstart="handleInput('left', this, event)"
                        class="btn-control h-14 rounded bg-slate-800 flex items-center justify-center text-xl shadow-lg">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button 
                        onmousedown="handleInput('stop', this)" ontouchstart="handleInput('stop', this, event)"
                        class="btn-control h-14 rounded bg-red-900/50 border-red-500 flex items-center justify-center text-xl shadow-lg text-red-400">
                        <i class="fas fa-stop"></i>
                    </button>
                    <button id="btn-right" 
                        onmousedown="handleInput('right', this)" ontouchstart="handleInput('right', this, event)"
                        class="btn-control h-14 rounded bg-slate-800 flex items-center justify-center text-xl shadow-lg">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <div></div>
                    <button id="btn-bwd" 
                        onmousedown="handleInput('bwd', this)" ontouchstart="handleInput('bwd', this, event)"
                        class="btn-control h-14 rounded bg-slate-800 flex items-center justify-center text-xl shadow-lg">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div></div>
                </div>

                <!-- Extra Actions -->
                <div class="grid grid-cols-2 gap-2 mt-auto">
                    <button onclick="sendCommand('horn')" class="btn-control py-2 rounded bg-yellow-900/20 border-yellow-500 text-yellow-500 text-xs font-bold hover:bg-yellow-500 hover:text-black">
                        <i class="fas fa-bullhorn"></i> SIREN
                    </button>
                    <button onclick="toggleLight()" id="btn-light" class="btn-control py-2 rounded bg-blue-900/20 border-blue-500 text-blue-500 text-xs font-bold hover:bg-blue-500 hover:text-black">
                        <i class="fas fa-lightbulb"></i> LIGHTS
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Log Footer -->
    <div class="mt-4 glass-panel p-2 rounded border-t border-green-500 h-32 overflow-hidden flex flex-col">
        <div class="text-[10px] text-gray-500 uppercase tracking-widest border-b border-gray-800 mb-1">System Log / Terminal</div>
        <div id="sys-log" class="font-mono text-xs text-green-400/80 overflow-y-auto flex-grow space-y-1 p-1">
            <div>> SYSTEM INITIALIZED...</div>
            <div>> WAITING FOR UPLINK...</div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // --- REPLACE WITH YOUR CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDgJNgD6T19VSYp25yB17PwKxOmx2UP0cg",
            authDomain: "patrol-robot-238d5.firebaseapp.com",
            databaseURL: "https://patrol-robot-238d5-default-rtdb.firebaseio.com",
            projectId: "patrol-robot-238d5",
            storageBucket: "patrol-robot-238d5.firebasestorage.app",
            messagingSenderId: "632769521130",
            appId: "1:632769521130:web:c0ac6ad12704d5ea087e93",
            measurementId: "G-WR5CJKWND5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- UTILS: LOGGING ---
        window.logMsg = function(msg) {
            const logDiv = document.getElementById('sys-log');
            const time = new Date().toLocaleTimeString('en-US', {hour12: false});
            const entry = document.createElement('div');
            entry.innerText = `> [${time}] ${msg}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // --- STATUS MONITOR ---
        onValue(ref(db, ".info/connected"), (snap) => {
            const el = document.getElementById("connectionStatus");
            if (snap.val() === true) {
                el.innerText = "ONLINE";
                el.className = "text-xs md:text-sm bg-green-900 px-3 py-1 rounded border border-green-500 shadow-[0_0_10px_#00ff41]";
                logMsg("UPLINK ESTABLISHED");
            } else {
                el.innerText = "OFFLINE";
                el.className = "text-xs md:text-sm bg-red-900 px-3 py-1 rounded border border-red-500 animate-pulse";
                logMsg("CONNECTION LOST");
            }
        });

        // --- MAP SETUP ---
        let map, marker;
        function initMap() {
            const defaultLoc = [28.721, 77.102];
            map = L.map('map', {zoomControl: false}).setView(defaultLoc, 15);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: ''
            }).addTo(map);
            
            // Custom Icon
            const robotIcon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:#00ff41; width:10px; height:10px; border-radius:50%; box-shadow:0 0 10px #00ff41;'></div>",
                iconSize: [10, 10],
                iconAnchor: [5, 5]
            });
            
            marker = L.marker(defaultLoc, {icon: robotIcon}).addTo(map);
            logMsg("MAP SYSTEMS INITIALIZED");
        }
        initMap();

        // --- CONTROL LOGIC ---
        let currentCommand = 'stop';
        
        window.setMode = function(mode) {
            update(ref(db, 'robot/control'), { mode: mode })
                .then(() => {
                   document.getElementById('cmd-status').innerText = "MODE: " + mode.toUpperCase();
                   logMsg(`MODE SWITCHED TO ${mode.toUpperCase()}`);
                });
            
            // UI Toggle
            const manualBtn = document.getElementById('btn-manual');
            const autoBtn = document.getElementById('btn-auto');
            const dpad = document.getElementById('dpad');

            if(mode === 'auto') {
                manualBtn.className = "flex-1 py-1 text-sm rounded text-gray-400 hover:text-white";
                autoBtn.className = "flex-1 py-1 text-sm rounded bg-green-600 text-black font-bold hover:opacity-90";
                dpad.style.opacity = "0.3";
                dpad.style.pointerEvents = "none";
            } else {
                manualBtn.className = "flex-1 py-1 text-sm rounded bg-green-600 text-black font-bold hover:opacity-90";
                autoBtn.className = "flex-1 py-1 text-sm rounded text-gray-400 hover:text-white";
                dpad.style.opacity = "1";
                dpad.style.pointerEvents = "auto";
            }
        }

        window.handleInput = function(cmd, btnElement, event) {
            if(event) {
                event.preventDefault(); 
                event.stopPropagation();
            }
            if(currentCommand === cmd) return;
            sendCommand(cmd);
            currentCommand = cmd;
        }

        window.sendCommand = function(cmd) {
            document.getElementById('cmd-status').innerText = "SENDING: " + cmd.toUpperCase();
            update(ref(db, 'robot/control'), { command: cmd })
                .then(() => {
                     document.getElementById('cmd-status').innerText = "SENT: " + cmd.toUpperCase();
                     if(cmd !== 'stop') logMsg(`CMD TX: ${cmd.toUpperCase()}`);
                })
                .catch(err => logMsg(`ERROR: ${err.message}`));
        }

        window.toggleLight = function() {
            logMsg("TOGGLING LIGHTS...");
            // Toggle logic here if you add it to firmware
        }

        // --- GLOBAL STOP HANDLER (Mouse/Touch Release) ---
        const stopHandler = () => {
            if(currentCommand !== 'stop') {
                sendCommand('stop');
                currentCommand = 'stop';
                // Reset Key UI
                document.querySelectorAll('.btn-control').forEach(b => b.classList.remove('active-key'));
            }
        };
        window.addEventListener('mouseup', stopHandler);
        window.addEventListener('touchend', stopHandler);

        // --- KEYBOARD CONTROLS (WASD / Arrows) ---
        const keyMap = {
            'ArrowUp': 'fwd', 'w': 'fwd',
            'ArrowDown': 'bwd', 's': 'bwd',
            'ArrowLeft': 'left', 'a': 'left',
            'ArrowRight': 'right', 'd': 'right'
        };

        window.addEventListener('keydown', (e) => {
            if (keyMap[e.key]) {
                const cmd = keyMap[e.key];
                if(currentCommand !== cmd) {
                    // Highlight UI Button
                    const btnId = `btn-${cmd}`;
                    const btn = document.getElementById(btnId);
                    if(btn) btn.classList.add('active-key');
                    
                    sendCommand(cmd);
                    currentCommand = cmd;
                }
            }
        });

        window.addEventListener('keyup', (e) => {
            if (keyMap[e.key]) {
                stopHandler();
            }
        });

        // --- TELEMETRY LISTENER ---
        onValue(ref(db, 'robot/status'), (snapshot) => {
            const data = snapshot.val();
            if(!data) return;

            document.getElementById('val-dist').innerText = (data.distance || 0);
            document.getElementById('val-noise').innerText = (data.noise || 0);
            document.getElementById('val-speed').innerText = (data.gps?.speed || 0).toFixed(1);

            // Alerts
            const alertBox = document.getElementById('alert-box');
            if (data.alerts?.noise_alert || data.alerts?.theft_alert) {
                alertBox.className = "mt-2 p-1 text-center text-xs rounded font-bold alert-active";
                alertBox.innerText = `⚠️ THREAT DETECTED: ${data.alerts.noise_alert ? 'NOISE' : 'THEFT'}`;
                logMsg("!!! ALERT TRIGGERED !!!");
            } else {
                alertBox.className = "mt-2 p-1 text-center text-xs bg-slate-800 rounded text-gray-500";
                alertBox.innerText = "SECTOR SECURE";
            }

            // Map Update
            if (map && marker && data.gps) {
                const newLoc = [data.gps.lat, data.gps.lng];
                marker.setLatLng(newLoc);
                map.panTo(newLoc);
            }
        });
    </script>
</body>
</html>
